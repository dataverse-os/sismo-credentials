//SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

import "forge-std/Test.sol";
import {SismoCredential} from "../src/SismoCredential.sol";
import {BaseTest} from "./base/BaseTest.t.sol";
import {DataTypes} from "../src/libraries/DataTypes.sol";

contract SismoCredentialsTest is BaseTest {
    SismoCredential public sismoCredential;
    bytes response =
        hex"00000000000000000000000000000000000000000000000000000000000000201267ea070ec44221e85667a731eee04500000000000000000000000000000000b8e2054f8a912367e38a22ce773328ff000000000000000000000000000000007369736d6f2d636f6e6e6563742d76312e31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b5ab443dff53f0e397a9e0778a3343cbaf4d001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e600000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c00120debaf90e302583861b5f81200e0e04120ffc29738704d3e4339729a455fb26015aac5c5e059a755f6f8988172798553d22685e055c07252ffa3a6f9e9ff70d659630b588641e29cb1ae9478f1474c4427e0bfa6f25a6553ed6fd151dc6f414e9ee5778baa9dce98f3bc609ab7297143500bf891afb95f284b758bf438e94046d54d1c53cd415f604912dec3e50ef40f0f51bd489982c176658aa52dc41150b1f1e15edb2926f3778abc9c37372827591161acac216d25babddf3ee55911e0e9c32fa8c403fdd06de0cf640d9d8e4a79ac428c66f699a14c1afa4c2f1be2e0430d92fd1aeee7e3d25dd4a6229f7faec7200cd824da3e5b0738d4072914dd3000000000000000000000000000000000000000000000000000000000000000002b8a512b4aaebb2955485bc52ef1c2957ab167b3784a33ff5dff93ce2cc8e8b07f6c5612eb579788478789deccb06cf0eb168e457eea490af754922939ebdb920706798455f90ed993f8dac8075fc1538738a25f0c928da905c0dffd81869fa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e617deb519a568cd1e54da8d268b86077d4e3d1cbe735d60461ac36a99654bca9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000f44c3e70f9147f1a4d59077451535f00000000000000000000000000000000006c617465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c00b00686eb24d70c1beab294e3eaf5d76d44eaecb209bdb14c82a9b1b1d17af3e0d1cd71a5534e79f91eb94e6c99651456265823e99fdac1d92b1924685133c6f21e94e97895f99a47dacba3e58a96f8a244a663899518c41cb764e6d1e42f1c91c5cb78f5056e09c26f110e4651cb067826f7599193ef360e1adc978040e9d6505bc4c038e84ad3059eaeb2553b5f34895baa3ed7c90b69e9ac8cb635b2ebb1d1341af16ea4734e3c843d61c87088f45f02f5f3a6a56deee93e83545a11d2a2c0ed9c1284f3a66473051ebd5eba7aeea2c6cd53764f5610d25f9b1f9ff5d888b1effe109f93e5d49bbe2aa134a58ea6e41c93466671e220dec674cec205ce06a000000000000000000000000000000000000000000000000000000000000000002b8a512b4aaebb2955485bc52ef1c2957ab167b3784a33ff5dff93ce2cc8e8b07f6c5612eb579788478789deccb06cf0eb168e457eea490af754922939ebdb920706798455f90ed993f8dac8075fc1538738a25f0c928da905c0dffd81869fa015525b7872fd3c88f1837ccd17090a4631a00a8d60e8b39ef44fec5fce8bffa2b4d048d74ba4392342fcd8decf07742556ec7fae4eb17ff51e181f94fcfb48d143bf633750b17355486194a660c7cf29c7c05130a47fa78fde5cd2897e236f900000000000000000000000000000000000000000000000000000000000000010256b632931c5e49b3c7aae3c9cca52ea35deafb12d4cd29ac96341c4ffffffb00000000000000000000000000000000000000000000000000000000000000001ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e617deb519a568cd1e54da8d268b86077d4e3d1cbe735d60461ac36a99654bca90000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    bytes response2 =
        hex"00000000000000000000000000000000000000000000000000000000000000201267ea070ec44221e85667a731eee04500000000000000000000000000000000b8e2054f8a912367e38a22ce773328ff000000000000000000000000000000007369736d6f2d636f6e6e6563742d76312e31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000e77cd675c56ec561f4d5d29b96c7a282a2c95800000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e600000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c004e4b3054c50cac86291f711c449accfbae9524f9fbd8efa08e1de97c7e0dad01b80e396b5e105d18e43c0c43dc1a142a31539104e57dcab584579356e12cbdc199e690c3dae81cd7c38c816222bb8b722bd5d42028dd5ea8a67a698889c65791ae36b0e5a22ef4199c5351d7b1524394e8829bb373e7192427f1177d9b9ca842da4e467d32fb699bf9ef9406e97f858cf8334cf1fa7e6812af01bb7a6184dee25370920841bd46921ec6cce573784f6f3115c13d4195273a5b533e21420bebc2957f5625277e60a7ec5bea9037e51f99f8a3a9922f4f9c9f476171883dd53e909549d71c76bd88f490c78b47ae38eabdde1165d0a3ae12729dfb32fe217d2330000000000000000000000000000000000000000000000000000000000000000248d7dc95274b8ffd17b280bb8ca682802c6417be03d5092d3592eaa2f33476407f6c5612eb579788478789deccb06cf0eb168e457eea490af754922939ebdb920706798455f90ed993f8dac8075fc1538738a25f0c928da905c0dffd81869fa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e617deb519a568cd1e54da8d268b86077d4e3d1cbe735d60461ac36a99654bca9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000f44c3e70f9147f1a4d59077451535f00000000000000000000000000000000006c617465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c01889f6fec4ec2d819a05197d3e7c936d9983f9d49383d1562ecc1d5a6bd66f35295628b41c977b1c043f249d8ec1f8ae140508d948aad8188ef501b56803860e0e97b111aacd06130a987bf2d1047e1e8f667e28f48dd085b19f4fd8d53cda0d2f1c3f162a8410b7c47eaf5d604d19577b98ca039cc38c4a2eb335b1915877b203ba36579c43892d1ef13e1dd61b20fc49366f1a247f73701451214141985cb902cbc553e14a719a8962959426599432c9edc6e881aa2d7b84a504cfbe29879b1dd8d14193f8b9b22294de2b41aa84d9a5a17c2871334b87a38f55a3c46a3c320c5b68a7a0d5ca18f785f814fbf85e1981e2367572da8687dde51fb17bc26d060000000000000000000000000000000000000000000000000000000000000000248d7dc95274b8ffd17b280bb8ca682802c6417be03d5092d3592eaa2f33476407f6c5612eb579788478789deccb06cf0eb168e457eea490af754922939ebdb920706798455f90ed993f8dac8075fc1538738a25f0c928da905c0dffd81869fa015525b7872fd3c88f1837ccd17090a4631a00a8d60e8b39ef44fec5fce8bffa2b4d048d74ba4392342fcd8decf07742556ec7fae4eb17ff51e181f94fcfb48d143bf633750b17355486194a660c7cf29c7c05130a47fa78fde5cd2897e236f900000000000000000000000000000000000000000000000000000000000000010256b632931c5e49b3c7aae3c9cca52ea35deafb12d4cd29ac96341c4ffffffb00000000000000000000000000000000000000000000000000000000000000001ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e617deb519a568cd1e54da8d268b86077d4e3d1cbe735d60461ac36a99654bca9000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000007cccd0183c6ca02e76600996a671a824000000000000000000000000000000006c617465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c022ba9e965291a7daf8c8ced195a368a8a79d362c7912423bb35a9a988bf3975d0a8cbd9aacc23c9496c105b5f097c305e07cdf53e29e180e06c545cf19666afd0744edfe1507058e94ccebd4f7acd3e1b4fc33627fd34253f067281c11ca6c67280e1c2f3b36a5aa5ceec45b1f46de2672cf1c07205a402842c9d14f4887bc7c2566e4084015c4170671ad951343aa3c066ba2846d1c73c659de6d13d17c41a5037d751b768c9da7e5bd363f74c8d9f747ca6fffdcf57eda43bfde5119db63d2239b922b443d5bbf854dc4544b0179442bc71c42b91c0a731beda0b65ae6f98a0a7d131fe2781c9139e1c355e5b3069e7f746c97a82cffe771da50abf5c5e4e90000000000000000000000000000000000000000000000000000000000000000248d7dc95274b8ffd17b280bb8ca682802c6417be03d5092d3592eaa2f33476407f6c5612eb579788478789deccb06cf0eb168e457eea490af754922939ebdb920706798455f90ed993f8dac8075fc1538738a25f0c928da905c0dffd81869fa015525b7872fd3c88f1837ccd17090a4631a00a8d60e8b39ef44fec5fce8bffa15f0c9d010d22cbd1a93eb450fb1c5189d696a739c5d9fb92eea292854b658c60b60307b2601517d751fe508d666838676b02e581a6bb9c3888e6ca33f98a4a700000000000000000000000000000000000000000000000000000000000000011c0433327a095fdb05bf7e29a36ef76a1bf9a3d480011edd783c14d81ffffffe00000000000000000000000000000000000000000000000000000000000000001ced80673868b95a4e1e17b846881eedfd35ab926b3a90f6390a8af8027678e617deb519a568cd1e54da8d268b86077d4e3d1cbe735d60461ac36a99654bca90000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    // the appId from the Sismo Connect App we want to use
    bool isImpersonationMode = false; // <--- set to true to allow verifying proofs from impersonated accounts
    // sismo dataGroupIds
    bytes16 public constant TEAM_MEMBERS_GROUP_ID = 0xf44c3e70f9147f1a4d59077451535f00;
    bytes16 public constant G2M_GROUP_ID = 0x7cccd0183c6ca02e76600996a671a824;

    // bytes16 public constant DATA_GROUP_ID = 0x6d6ab4793a05fbdafbb8895f8e9eef14; // ten eths group

    // sismo appId
    bytes16 public constant APP_ID = 0x1267ea070ec44221e85667a731eee045;
    uint256 public constant DURATION = 7 days;

    address public owner = 0xb5AB443DfF53F0e397a9E0778A3343Cbaf4D001a;
    address public account = 0xb5AB443DfF53F0e397a9E0778A3343Cbaf4D001a;

    function setUp() public {
        _registerTreeRoot(0x04f0ace60fdf560415b93173156e67c6735946e9889973bfd56f1bcbe6fc5bcf);
        vm.startPrank(owner);
        DataTypes.GroupSetup[] memory groups = new DataTypes.GroupSetup[](2);
        groups[0] = (DataTypes.GroupSetup({groupId: TEAM_MEMBERS_GROUP_ID, startAt: 1000, duration: 1 days}));
        groups[1] = (DataTypes.GroupSetup({groupId: G2M_GROUP_ID, startAt: 12000, duration: 1 days}));

        sismoCredential = new SismoCredential(
            APP_ID,
            DURATION,
            isImpersonationMode,
            groups
        );
        vm.stopPrank();
    }

    function test_addDataGroups() public {
        bytes16 mockGroupId_01 = 0x7cccd0183c6ca02e76600996a6710001;
        bytes16 mockGroupId_02 = 0x7cccd0183c6ca02e76600996a6710002;

        DataTypes.GroupSetup[] memory groups = new DataTypes.GroupSetup[](2);
        groups[0] = (DataTypes.GroupSetup({groupId: mockGroupId_01, startAt: 1000, duration: 1 days}));

        groups[1] = (DataTypes.GroupSetup({groupId: mockGroupId_02, startAt: 12000, duration: 1 days}));

        vm.prank(owner);
        sismoCredential.addDataGroups(groups);

        assertEq(sismoCredential.getGroupIds()[2], mockGroupId_01);
        assertEq(sismoCredential.getGroupIds()[3], mockGroupId_02);
    }

    function test_deleteDataGroups() public {
        bytes16[] memory groupIds = new bytes16[](2);
        groupIds[0] = TEAM_MEMBERS_GROUP_ID;
        groupIds[1] = G2M_GROUP_ID;

        vm.prank(owner);
        sismoCredential.deleteDataGroups(groupIds);

        uint256 num = sismoCredential.getGroupIds().length;
        assertEq(num, 0);
    }

    function test_bindCredential() public {
        vm.prank(account);
        sismoCredential.bindCredential(account, response);

        DataTypes.CredentialInfo[] memory reps = sismoCredential.getCredentialInfoList(account);

        uint256 expiredAt = block.timestamp + 1 days - ((block.timestamp - 1000) % 1 days);
        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, true);
        assertEq(reps[0].expiredAt, expiredAt);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);
        assertEq(reps[1].expiredAt, 0);
    }

    function test_getCredential() public {
        vm.prank(account);
        sismoCredential.bindCredential(account, response);

        uint256 expiredAt = block.timestamp + 1 days - ((block.timestamp - 1000) % 1 days);

        vm.warp(block.timestamp + 100 days);
        DataTypes.CredentialInfo[] memory reps = sismoCredential.getCredentialInfoList(account);

        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, false);
        assertEq(reps[0].expiredAt, expiredAt);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);
        assertEq(reps[1].expiredAt, 0);
    }

    function test_getCredentialInfoList_should_not_return_deleted_credential() public {
        vm.prank(account);
        sismoCredential.bindCredential(account, response);
        uint256 expiredAt = block.timestamp + 1 days - ((block.timestamp - 1000) % 1 days);

        vm.warp(block.timestamp + 100 days);

        DataTypes.CredentialInfo[] memory reps = sismoCredential.getCredentialInfoList(account);

        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, false);
        assertEq(reps[0].expiredAt, expiredAt);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);
        assertEq(reps[1].expiredAt, 0);

        bytes16[] memory groupIds = new bytes16[](1);
        groupIds[0] = TEAM_MEMBERS_GROUP_ID;

        vm.prank(account);
        sismoCredential.deleteDataGroups(groupIds);
        reps = sismoCredential.getCredentialInfoList(account);
        assertEq(reps[0].groupId, G2M_GROUP_ID);
        assertEq(reps[0].value, false);
        assertEq(reps[0].expiredAt, 0);
    }

    function test_should_bind_new_account_after_refresh_duration() public {
        vm.prank(account);
        sismoCredential.bindCredential(account, response);

        DataTypes.CredentialInfo[] memory reps = sismoCredential.getCredentialInfoList(account);

        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, true);
        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);

        // before account refresh time , new account should not be bound,
        // but update previous account on reputation expired time
        vm.warp(block.timestamp + 6 days);
        address anotherAccount = 0x0E77cD675c56Ec561F4D5D29B96c7A282A2C9580;

        vm.prank(account);
        sismoCredential.bindCredential(anotherAccount, response2);

        reps = sismoCredential.getCredentialInfoList(anotherAccount);

        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, false);
        assertEq(reps[0].expiredAt, 0);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);
        assertEq(reps[1].expiredAt, 0);

        // after 7 days should bind to new account
        vm.warp(block.timestamp + 1 days);

        vm.prank(anotherAccount);
        sismoCredential.bindCredential(anotherAccount, response2);

        reps = sismoCredential.getCredentialInfoList(anotherAccount);

        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, true);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, true);

        reps = sismoCredential.getCredentialInfoList(account);
        assertEq(reps[0].groupId, TEAM_MEMBERS_GROUP_ID);
        assertEq(reps[0].value, false);
        assertEq(reps[0].expiredAt, 0);

        assertEq(reps[1].groupId, G2M_GROUP_ID);
        assertEq(reps[1].value, false);
        assertEq(reps[1].expiredAt, 0);
    }
}
